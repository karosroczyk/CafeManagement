version: '3.9'

services:
# Menu
  menumanagement:
    container_name: menumanagement
    image: menumanagement:v.1.0
    ports:
      - "8081:8081"
    depends_on:
      db_menu:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db_menu:3306/menumanagement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: menumanagement
      SPRING_DATASOURCE_PASSWORD: menumanagement
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQL8Dialect
      SERVER_PORT: 8081

  db_menu:
    image: mysql:8.0
    container_name: mysql-menudb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: menumanagement
      MYSQL_USER: menumanagement
      MYSQL_PASSWORD: menumanagement
    ports:
      - "3307:3306"
    volumes:
      - db_menu_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10

# Inventory
  inventorymanagement:
    container_name: inventorymanagement
    image: inventorymanagement:v.1.0
    ports:
      - "8082:8082"
    depends_on:
      db_inventory:
        condition: service_healthy
      eureka:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db_inventory:3306/inventorymanagement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: inventorymanagement
      SPRING_DATASOURCE_PASSWORD: inventorymanagement
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQL8Dialect
      SERVER_PORT: 8082
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka:8761/eureka

  db_inventory:
    image: mysql:8.0
    container_name: mysql-inventorydb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: inventorymanagement
      MYSQL_USER: inventorymanagement
      MYSQL_PASSWORD: inventorymanagement
    ports:
      - "3308:3306"
    volumes:
      - db_inventory_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10

# Order
  ordermanagement:
    container_name: ordermanagement
    image: ordermanagement:v.1.0
    ports:
      - "8083:8083"
    depends_on:
      db_order:
        condition: service_healthy
      eureka:
        condition: service_started
    #      menumanagement:
    #        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db_order:3306/ordermanagement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: ordermanagement
      SPRING_DATASOURCE_PASSWORD: ordermanagement
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQL8Dialect
      SERVER_PORT: 8083
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka:8761/eureka

  db_order:
    image: mysql:8.0
    container_name: mysql-orderdb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ordermanagement
      MYSQL_USER: ordermanagement
      MYSQL_PASSWORD: ordermanagement
    ports:
      - "3309:3306"
    volumes:
      - db_order_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10

# User
  usermanagement:
    container_name: usermanagement
    image: usermanagement:v.1.0
    ports:
      - "8088:8088"
    depends_on:
      db_user:
        condition: service_healthy
      eureka:
        condition: service_started
    #      menumanagement:
    #        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db_user:3306/usermanagement?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: usermanagement
      SPRING_DATASOURCE_PASSWORD: usermanagement
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQL8Dialect
      SERVER_PORT: 8088
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka:8761/eureka

  db_user:
    image: mysql:8.0
    container_name: mysql-userdb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usermanagement
      MYSQL_USER: usermanagement
      MYSQL_PASSWORD: usermanagement
    ports:
      - "3310:3306"
    volumes:
      - db_user_data:/var/lib/mysql
#      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10

  eureka:
    image: discoveryserver:v.1.0
    container_name: discoveryserver
    ports:
      - "8762:8761"

  maildev:
    image: maildev/maildev
    container_name: maildev
    ports:
      - "1080:1080"
      - "1025:1025"

  frontend:
    image: frontend:v.1.0
    container_name: frontend
    ports:
      - "8080:80"
      - "1026:1025"

volumes:
  db_menu_data:
  db_inventory_data:
  db_order_data:
  db_user_data:

#  networks:
#    cafe:
#      driver: bridge

##volumes:
##  postgres:
##    driver: local
###  keycloak:
###    driver: local